package controller;

import java.util.Calendar;
import org.zkoss.zk.ui.Component;
import org.zkoss.zk.ui.select.SelectorComposer;
import org.zkoss.zk.ui.select.annotation.Listen;
import org.zkoss.zk.ui.select.annotation.Wire;
import org.zkoss.zul.Datebox;
import org.zkoss.zul.Spinner;

public class DateboxComposer extends SelectorComposer<Component> {

	/**
	 * 
	 */
	private static final long serialVersionUID = -2490997507521961886L;

	@Wire
	private Datebox startDatebox, endDatebox;
	@Wire
	private Spinner spinner;

	@Listen("onChange = #startDatebox, #endDatebox")
	public void onChangeTime() {
		Calendar startCal = Calendar.getInstance();
		startCal.setTime(startDatebox.getValue());
		int startDay = startCal.get(Calendar.DAY_OF_WEEK);
		Calendar endCal = Calendar.getInstance();
		endCal.set(Calendar.HOUR_OF_DAY, 23);
		endCal.set(Calendar.MINUTE, 59);
		endCal.set(Calendar.SECOND, 59);
		endCal.setTime(endDatebox.getValue());

		double daysBetween = ((double) (endCal.getTimeInMillis() - startCal
				.getTimeInMillis())) / (24 * 60 * 60 * 1000);
		int weeks = (int) Math.floor(daysBetween / 7) * 5;
		int remainDays = (int) Math.ceil(daysBetween % 7);

		if (Calendar.SUNDAY == startDay) {
			startDay = Calendar.MONDAY;
			remainDays--;
		}
		int offset = startDay + remainDays - Calendar.SATURDAY;
		// if (offset >= 0)
		// remainDays -= offset >= 2 ? 2 : offset;
		if (offset == 0) {
			remainDays -= 1;
		} else if (offset >= 1) {
			remainDays -= 2;
		}

		spinner.setValue(remainDays + weeks);
	}

	@Listen("onChange = #spinner")
	public void onChangeWorkingDay() {
		int numberOfWorkingDays = spinner.getValue();
		int numberOfWeek = numberOfWorkingDays / 5;
		int remainDays = numberOfWorkingDays % 5;

		Calendar startCal = Calendar.getInstance();
		startCal.setTime(startDatebox.getValue());
		int startDay = startCal.get(Calendar.DAY_OF_WEEK);

		if (Calendar.SUNDAY == startDay) {
			startDay = Calendar.MONDAY;
		}
		// Vì ngày hiện tại luôn được tính là 1 ngày nên remainDays sẽ bị trừ đi
		// 1
		int offset = startDay + --remainDays - Calendar.SATURDAY;
		if (offset >= 0) {
			remainDays += offset >= 1 ? 2 : offset;
		}
		if(offset == 0) {
			remainDays++;
		}else if(offset >= 1) {
			remainDays += 2;
		}
		startCal.add(Calendar.DAY_OF_YEAR, remainDays + numberOfWeek * 7);
		endDatebox.setValue(startCal.getTime());
	}
}
